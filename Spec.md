# wixproj 拡張プロジェクトのざっくり仕様
* インストーラに販売元の署名をつけるので最終ビルドは販売元
  * 署名処理の段取りを開発元に持ってこさせないための工夫が必要
  * 開発元でもビルドはできること
* メディアイメージを自動生成できる
  * ISOイメージ(使えていない様子)があれば解決する

# 過去に抱えていた問題点
* ビルド時に人的作業が介在していた
  * msi と cab への署名を後付けで行っていた
    * msi内部に署名フィールドがない！
* ISOのビルドがOSCDIMG に依存していた
  * 結果使ってもらえない事態に。。。
* そもそも販売元にISOファイルの意図が理解されていない
  * いまだに解決できず。。。

# ざっくり過去

## MS-DOS時代
* 開発元製スクリプト型インストーラ
  * コンソールベース
  * 汎用スクリプト型
    * 任意のアプリでインストーラを作れること
  * 対FDD向け機能を搭載
    * メディアのフォーマットコマンドなど
  * 対HDD向け機能を搭載
    * HDDとFDDとでコピー先を識別して対応する(メディアフォーマットしないなど)

## Windows 3.1 時代
* 販売元製独自インストーラを利用
* 先行していた別製品向けに作られたものを販売元で独自に用意
* 基本はHDDへの単純コピー(GUI形式)

## Windows 95 版
* 3.1 時代のものをそのまま流用
* アプリは32bit化(Win32Sで3.1に対応)
* インストーラがどうなっていたかは不明

## InstallShield 版
* それまでの流れで販売元で作成
* ARP(Add/Remove Programs)対応
* アプリ本体は 16bit 環境がなくなったため大幅刷新

#### 当時の課題
* 共有ファイルの製品間・バージョン間共有
* OCXは同じものを複数の製品で使いたい
* インストール先をローカルではなく専用フォルダに(Systemではない)
* 共有ファイルとしてカウント
* 自己登録・登録解除への対応
* 事実上の DLL-Hell 問題

## 開発元製独自版
* インストーラの
* Windows Installer 発表前の世代
* InstallShieldでの開発に限界があった
* 差分パッチ形式でのアップデータも提供

#### 当時の課題
* エンジンの Windows Installer への移行
  * Windows XP Certified ロゴへの対応
* 共有ファイル管理の仕組み上のリミットへの対応
  * 9x 系OSのレジストリ64K問題
* フォント登録がうまくいかない環境がある

## InstallScriptMSI 版
* 独自版の限界による移植
  * MSIが必須
    * 9x系OSの64K問題の回避
  * 短期開発の必要性(当初実装予定２週間程度)

#### 当時の課題
* 不安定
  * InstallScript + MSI という構造そのものの抱える欠陥
* フォント登録がうまくいかない環境が結果あまり変わらない

## BasicMSI版
* 一般化しつつあったため、BasicMSI(InstallScriptを使わないMSI形式)に移行
  * UIの見た目が変わるなどいくつか大きな変更有
* CustomActions の導入(超えられない壁の突破)

#### 当時の課題
* 機械化できない作業コストの増大
* バイナリデータなので単純コピーができないことの弊害

## WiX 2.0版
* 人的作業に頼っていた部分の機械化に成功
  * メディアイメージの自動作成
  * インストーラバージョンの自動設定
  * ComponentIdなどをプロジェクト管理で共有化
* ビルド時間の大幅短縮
  * ツールの違いなので単なる結果論

#### 当時の課題
* 技術者不足(主に販売元サイド)
* NMAKEをベースとしたビルドエンジンをどうするか

## WiX 3.x版(初期版)
* Votive の完成を待って導入
  * 依存プロジェクトのビルド
* Votive では対応していない部分のカスタマイズ
  * カスタマイズ機能Ver.1.0の導入

#### 当時の課題
* WiX の変化が速いことへの対応の課題
  * カスタムプロジェクトがWiXのバージョンにがっちり依存していた
* ISOビルドのみNMAKEのまま変えられないことへの対応

## WiX 3.x版(初期完成版)
* ISOビルドのMSBuild対応
  * wixproj をカスタマイズする形で導入
    * VS連携部分の開発コストをかけないことでコスト削減
  * wixproj のカスタマイズ機能を単一で提供
    * VSのバージョン追従が難しく共通化が難しい
* マイナーバージョンアップを続けていくことで変化に対応

# V2プロジェクト発足
#### 今回の課題
* VS2017 環境への対応
  * プロジェクトツールの管理スタイルが根本的に大幅変更
* WiX の大掛かりなバージョンアップ
  * Votive の分離とそれに伴う環境の変化
* 今となっては不要となった各種機能の撤去
* WiXのバージョンに依存しないカスタマイズ
* ISOビルド時の依存関係取り込み漏れ
* WiXのビルドエンジンの吐き出す依存リストに漏れがあるかの再チェック


## VS2017 環境への対応
* targets ファイルの配置先変更
  * $(MSBuildProgramFiles32) に直接配置
    * $(MSBuildExtensionsPath) がVSの構成に依存する
* targets ファイル構成の分離
  * 機能別に分離
    * 自動バージョン設定
      * CustomAfterWixTargets による機能拡張
      * 独自Target の追加
      * 既存Target の入れ替え
        * バグ回避＋機能改善＋機能追加
    * 署名付け
      * CustomAfterWixTargets による機能拡張
      * 自動バージョン設定への埋め込んで単一的に扱う
    * ISOビルド
      * 構造のみWiXを利用してビルドロジックを完全分離
      * WiX のビルドエンジンは基本的に必要としない
        * プロジェクト参照も仕組み自体はMSBuild標準で十分





* ISO ファイルをビルドすることで
* 定期的に上がる人的ミスの回避
* InstallShield のバージョンアップ問題の回避
  * 最新版が使えないジレンマの解決
    * 当時使っていたのはサポートの切れた DevStudio 9.0
    * 最新版ISの利用が下りない不思議な事情
      * 別プロダクトでは使われたにもかかわらず。。。
* WiX + NMAKE で構成
  * WiXのVS統合機能はまだ開発途中でバギーだった
  * 開発と販売(ビルド先)で会社が違うためいろいろ面倒な政治が必要になることの回避
* ISOをビルドするようにして、メディア作成も自動化
  * 運用で対応を回避

## WiX 3.x 版
* Votive(VS統合機能) を導入して完全にWiX環境でのビルドを可能に
 

## 
* 署名の自動処理
  * 搭載当時はmspがあったので昇格なしパッチを可能とするためのもの
* ビルドは全自動
* メディアイメージを用意できる
 
## 最終ビルドは、販売元
## 


# wixproj 拡張プロジェクトができるまでの歴史

## MS-DOS 時代
* 開発元製スクリプト型インストーラ
  * コンソール形式
  * 対FDDでのメディアコピーが主体
  * HDD 運用にも対応(単純コピー)

## Windows 版の開始
* 提供は Windows 3.1 から(1994年)
  * 16bit 版
    * Middium モデルといえばわかるかな？という特殊事情
      * DOS版はLargeモデル
  * Visual C++ 1.0 で開発
    * MFC 2.0
   * C++ 開発経験なし、Windows 開発経験なしからのスタート
     * 経験者は１名ほど...
  * 販売元では先行してWindows版の別製品を出していた
    * 流用できるものはそちらを利用

## 1994〜1995年のごたごた
* MAC対応の急浮上
  * 68000からPowerPCに切り替わる時期
  * Visual C++ for MACの国内販売があった
    * 最終的に MSDN に載らないままの亜流品で終わる...
      * Windowsベースでのクロスプラットフォーム
        * 実際に Office でも使っていた
        * OLE 1.0 フルスペック対応
        * MFC が完全移植
          * 当時は MFC 2.0 ベース
      * OLE 2.0 フルスペック対応はのちに販売
        * VC++ は 2.0 に移行、MFCは3.0に
          * ただし国内販売はされないまま
    * 32bit コードであればソース共有可能
      * Windows NT 3.5(3.1は未対応)以上の環境が必須
  * 宛名職人の土俵で勝負しようぜ！
    * それなりに行けてたらしいです
  * 対応しました！
    * 16bit版から 32bit 版に移植
      * エンディアン問題とか
      * VC++MACのバグ回避とか

## Windows 95 の発売
* 32bit化できてしまっていた
  * MAC版があった唯一の利点





## Windows 3.x 時代(黒歴史前史)
* 販売元製GUI型インストーラ
  * 別製品で先に Windows 版が出ていたためそれを流用
* アプリの事情
  * Windows 3.0 ではまだ時期尚早と見送り
    * この時点で一名に先行で開発環境の選定と学習がスタート
  * Windows 3.1 の発売
    * 対応は必須との判断が下る
      * 最新 Windows SDKへの対応は Visual C++ が若干早かった
        * 日本語版の話
      * MFCの利用が前提
        * VB もあったがベーシックじゃないよね？という判断
        * C++ と Windows 開発の同時学習
          * まぁ推して知るべし
    * 結果的には一番売れた(実は２番手スタート)
      * ちなみに、当時の売れ筋一番手は 95Wave を乗りこなせなくて（ｒｙ



* 当時のMAC事情
  * 68000 から PowerPC に移行していた時期
    * SDKの提供はPascalからC++ベースに変更
* 当時のWindows版事情
  * プロジェクト Chicago のリリース直前
    * MAC版対応中に海の向こうではリリース
  * アプリの 32bit 化をするかどうかが悩ましい課題


    
  * for Windows の開発を何で行うか？
    * DOS版もあったので開発環境はPC-98
    * DOS版は MSC7
    * 別製品では Borland C++も利用
  * Windows アプリをフルスクラッチするのは難しい
     * Programming Windows の読破が最低条件
     * 独自のGUI形式への対応
   * Windows SDK に対応したコンパイラ
     * 国内事情で動く製品の必要があった
       * 実質的な選択肢
         * MS-C(のちのVisual C++)
         * Borland C++(のちに消えゆくことに)
       * SDK 対応が一歩速いのはMS製
         * リンカーの事情は結構大きな問題だった
       * 
     
    * Visual C++ の販売開始
      * MS製なら対応も早い(Windows での開発はSDKが必須)
        





## 激闘の黒歴史(1994〜1996)
* MAC版販売へ
  * 当時のマック事情は 68000からPowerPCに代わる時代
  * Windows 版の移植が前提
    * OLE があるが？
    * MFC バリバリだよ？
    * Visual C++ for Mac(初期版)で対応
      * MAC 版は 32bit のみ
      * ここの話はまぁどこかで。。。
* Chicago(のちの Windows 95) 対応
  * 32bit 化するのか？
    * for Mac で、32bit 版VC++は導入済み
    * Win32S を使えば 3.1 でも 32bit 版は動作可能
      * ここの話はまぁどこかで。。。
* 

## Windows 95 時代の対応
* Windows 95 ロゴへの対応
  * ARP(Add/Remove Programs) の導入
  * 共有モジュール への対応

* この当時の開発事情
  * Windows 95 の開発と同時期の開発
    * アプリケーション側の32bit化
      * 営業戦略的なアプローチ
        * 結果トップシェアに躍り出る
        * Windows 95 ロゴにも対応
      * 基本的に短期型開発のため開発元は全社的対応が余儀なくされる
    * インストーラ事情
      * 販売元製インストーラを流用
        * 別製品が先に Windows 対応していた関係でそのまま流用できた




### 解決のための糸口
* 独自開発
* から、実績のある InstallShield への変更
  * 当時販売元でインストーラをビルド
    * 開発スケジュール的な問題
      * 開発元側での対応が間に合わない
  * 発覚した問題
    * 



## ざっくり要件

* 署名につく会社名の都合で開発元での最終ビルドは行わない
* ビルドは技術者ではなくても行えること
* Visual Studio は使っていい
* ビルドに必要な定義は開発元から提出
* 出力ファイルの署名をビルド時に自動で行う
* ビルド前の人的作業を無用にしたい


リリース向けのビルドは開発元ではなく販売元(企画元)で行う。


## 別会社で最終ビルドを可能とした半自動ビルドシステム


### インストーラの署名は開発元ではなく販売元
